@app.route('/blackjack', methods=['GET', 'POST'])
def blackjack_page():
    user_id = session.get('user_id')
    if not user_id:
        return redirect(url_for('login'))
    
    balance = get_user_balance(user_id)
    message = ""
    
    if 'blackjack_deck' not in session or request.form.get('action') == 'new_game':
        session['blackjack_deck'] = BlackjackGame.new_deck()
        session['player_hand'] = []
        session['dealer_hand'] = []
        session['game_state'] = 'betting'
        session['blackjack_bet'] = 0
    
    if request.method == 'POST':
        action = request.form.get('action')
        
        if action == 'place_bet':
            bet = int(request.form.get('bet', 10))
            
            if bet > balance:
                message = "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!"
            else:
                player_hand, dealer_hand, deck = BlackjackGame.deal_initial_cards(session['blackjack_deck'])
                session['player_hand'] = player_hand
                session['dealer_hand'] = dealer_hand
                session['blackjack_deck'] = deck
                session['blackjack_bet'] = bet
                session['game_state'] = 'player_turn'
                
                new_balance = balance - bet
                update_user_balance(user_id, new_balance)
                balance = new_balance
                
                player_value = BlackjackGame.calculate_hand_value(player_hand)
                if player_value == 21:
                    session['game_state'] = 'dealer_turn'
                    session['dealer_hand'], session['blackjack_deck'] = BlackjackGame.dealer_play(
                        session['dealer_hand'], session['blackjack_deck']
                    )
                    dealer_value = BlackjackGame.calculate_hand_value(session['dealer_hand'])
                    
                    if dealer_value == 21:
                        new_balance = balance + bet
                        update_user_balance(user_id, new_balance)
                        message = "ü§ù –û–±–∞ –∏–º–µ—é—Ç –±–ª—ç–∫–¥–∂–µ–∫! –ù–∏—á—å—è!"
                        session['game_state'] = 'game_over'
                        add_game_history(user_id, 'blackjack', bet, 0, 'push')
                    else:
                        win_amount = int(bet * 2.5)
                        new_balance = balance + win_amount
                        update_user_balance(user_id, new_balance)
                        message = f"üéâ –ë–ª—ç–∫–¥–∂–µ–∫! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {win_amount} ‚Çø!"
                        session['game_state'] = 'game_over'
                        add_game_history(user_id, 'blackjack', bet, win_amount - bet, 'blackjack')
                    balance = new_balance
        
        elif action == 'hit':
            session['player_hand'], session['blackjack_deck'] = BlackjackGame.hit(
                session['player_hand'], session['blackjack_deck']
            )
            
            player_value = BlackjackGame.calculate_hand_value(session['player_hand'])
            if player_value > 21:
                message = "üí• –ü–µ—Ä–µ–±–æ—Ä! –î–∏–ª–µ—Ä –≤—ã–∏–≥—Ä–∞–ª!"
                session['game_state'] = 'game_over'
                add_game_history(user_id, 'blackjack', session['blackjack_bet'], 0, 'bust')
        
        elif action == 'stand':
            session['game_state'] = 'dealer_turn'
            session['dealer_hand'], session['blackjack_deck'] = BlackjackGame.dealer_play(
                session['dealer_hand'], session['blackjack_deck']
            )
            
            player_value = BlackjackGame.calculate_hand_value(session['player_hand'])
            dealer_value = BlackjackGame.calculate_hand_value(session['dealer_hand'])
            
            winner = BlackjackGame.determine_winner(player_value, dealer_value)
            
            if winner == "player":
                win_amount = session['blackjack_bet'] * 2
                new_balance = balance + win_amount
                update_user_balance(user_id, new_balance)
                message = f"üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {win_amount} ‚Çø!"
                add_game_history(user_id, 'blackjack', session['blackjack_bet'], session['blackjack_bet'], 'win')
                balance = new_balance
            elif winner == "dealer":
                message = "üòû –î–∏–ª–µ—Ä –≤—ã–∏–≥—Ä–∞–ª!"
                add_game_history(user_id, 'blackjack', session['blackjack_bet'], 0, 'lose')
            else:
                new_balance = balance + session['blackjack_bet']
                update_user_balance(user_id, new_balance)
                message = "ü§ù –ù–∏—á—å—è! –°—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞"
                add_game_history(user_id, 'blackjack', session['blackjack_bet'], 0, 'push')
                balance = new_balance
            
            session['game_state'] = 'game_over'
    
    player_hand = session.get('player_hand', [])
    dealer_hand = session.get('dealer_hand', [])
    game_state = session.get('game_state', 'betting')
    
    player_value = BlackjackGame.calculate_hand_value(player_hand) if player_hand else 0
    dealer_value = BlackjackGame.calculate_hand_value(dealer_hand) if dealer_hand else 0
    
    show_dealer_value = game_state in ['dealer_turn', 'game_over']
    dealer_display_hand = dealer_hand.copy()
    if not show_dealer_value and len(dealer_display_hand) > 1:
        dealer_display_hand[1] = '??'
    
    return render_template('blackjack.html',
                         balance=balance,
                         player_hand=player_hand,
                         dealer_hand=dealer_display_hand,
                         player_value=player_value,
                         dealer_value=dealer_value if show_dealer_value else '?',
                         message=message,
                         game_state=game_state,
                         current_bet=session.get('blackjack_bet', 0))

@app.route('/reset_balance')
def reset_balance():
    user_id = session.get('user_id')
    if not user_id:
        return redirect(url_for('login'))
    
    update_user_balance(user_id, 1000)
    
    conn = sqlite3.connect('casino.db')
    cursor = conn.cursor()
    cursor.execute('DELETE FROM game_history WHERE user_id = ?', (user_id,))
    conn.commit()
    conn.close()
    
    if 'blackjack_deck' in session:
        del session['blackjack_deck']
    if 'player_hand' in session:
        del session['player_hand']
    if 'dealer_hand' in session:
        del session['dealer_hand']
    if 'game_state' in session:
        del session['game_state']
    if 'blackjack_bet' in session:
        del session['blackjack_bet']
    
    flash('–ë–∞–ª–∞–Ω—Å —Å–±—Ä–æ—à–µ–Ω –¥–æ 1000 ‚Çø', 'success')
    return redirect('/')

if __name__ == '__main__':
    init_db()
    app.run(debug=True, host='0.0.0.0', port=5000)